application: funkotron

# common settings for all environments
common:
  solution_stack_name: 64bit Amazon Linux 2014.09 v1.2.1 running Docker 1.5.0
  tier: WebServer
  region: eu-central-1
  strategy: blue-green
  package_bucket: funkotron-eu-central-1
  phoenix_mode: false
  version_label: <%= ENV['Build'] || ENV['SNAP_SNAP_PIPELINE_COUNTER'] || `git rev-parse --short HEAD`.strip %>
  smoke_test: |
    curl_http_code = "curl -s --user won:jackpot -o /dev/null -w \"%{http_code}\" http://#{host_name}/article/1337"
    Timeout.timeout(600) do
      until ['200', '301', '302'].include?(`#{curl_http_code}`.strip)
        sleep 5
      end
    end
  resources:

environments:
  devel:
    option_settings:
      #
      # Required application configuration
      #
      - namespace: aws:elasticbeanstalk:customoption
        option_name: CONFIG_URL
        value: https://s3.eu-central-1.amazonaws.com/silver-config-eu-central-1/devel/funkotron/runtime.conf
      #
      # VPC environment/instance configuration
      #
      - namespace: aws:autoscaling:launchconfiguration
        option_name: InstanceType
        value: <%= ENV['INSTANCE_TYPE'] || "t2.small" %>
      - namespace: aws:autoscaling:launchconfiguration
        option_name: IamInstanceProfile
        value: <%= ENV['IAM_INSTANCE_PROFILE'] || "staging-environment-InstanceProfile-NIE8WYGJGWE5" %>
      - namespace: aws:elasticbeanstalk:customoption
        option_name: IamInstanceRole
        value: <%= ENV['IAM_INSTANCE_ROLE'] || "staging-environment-InstanceRole-BWFUQVLEJ6H0" %>
      - namespace: aws:autoscaling:launchconfiguration
        option_name: EC2KeyName
        value: <%= ENV['EC2_KEY_NAME'] || "staging-bootstrap" %>
      # vpc:VpcInstanceSecurityGroup
      # environment:InstanceSecurityGroup
      - namespace: aws:autoscaling:launchconfiguration
        option_name: SecurityGroups
        value: <%= ENV['SECURITY_GROUPS'] || "sg-ab4c9cc2,sg-5c0ede35" %>
      - namespace: aws:ec2:vpc
        option_name: VPCId
        value: <%= ENV['VPC_ID'] || "vpc-b08745d9" %>
      - namespace: aws:ec2:vpc
        option_name: AssociatePublicIpAddress
        value: "false"
      - namespace: aws:ec2:vpc
        option_name: Subnets
        value: <%= ENV['SUBNETS'] || "subnet-456cb82c,subnet-5934c322" %>
      - namespace: aws:ec2:vpc
        option_name: ELBSubnets
        value: <%= ENV['ELB_SUBNETS'] || "subnet-446cb82d,subnet-5a34c321" %>
      #
      # Enable log publishing to S3
      #
      - namespace: aws:elasticbeanstalk:hostmanager
        option_name: LogPublicationControl
        value: "true"
      #
      # Notifications
      #
      - namespace: aws:elasticbeanstalk:sns:topics
        option_name: NotificationTopicName
        value: <%= ENV['NOTIFICATION_TOPIC'] || "staging-notification" %>

  production:
    option_settings:
      #
      # Required application configuration
      #
      - namespace: aws:elasticbeanstalk:application:customoption
        option_name: CONFIG_URL
        value: https://s3.eu-central-1.amazonaws.com/silver-config-eu-central-1/production/funkotron/runtime.conf
      #
      # VPC environment/instance configuration
      #
      - namespace: aws:autoscaling:launchconfiguration
        option_name: InstanceType
        value: t2.small
      - namespace: aws:autoscaling:launchconfiguration
        option_name: IamInstanceProfile
        value: <%= ENV['IAM_INSTANCE_PROFILE'] || "production-environment-InstanceProfile-HN2HA5XRDEAU" %>
      - namespace: aws:elasticbeanstalk:customoption
        option_name: IamInstanceRole
        value: <%= ENV['IAM_INSTANCE_ROLE'] || "production-environment-InstanceRole-1QR8U10AS2350" %>
      - namespace: aws:autoscaling:launchconfiguration
        option_name: EC2KeyName
        value: <%= ENV['EC2_KEY_NAME'] || "production-bootstrap" %>
      - namespace: aws:autoscaling:launchconfiguration
        option_name: SecurityGroups
        value: <%= ENV['SECURITY_GROUPS'] || "sg-0170a068,sg-ab70a0c2" %>
      - namespace: aws:ec2:vpc
        option_name: VPCId
        value: <%= ENV['VPC_ID'] || "vpc-9fb775f6" %>
      - namespace: aws:ec2:vpc
        option_name: AssociatePublicIpAddress
        value: "false"
      - namespace: aws:ec2:vpc
        option_name: Subnets
        value: <%= ENV['SUBNETS'] || "subnet-9abd6af3,subnet-d402f5af" %>
      - namespace: aws:ec2:vpc
        option_name: ELBSubnets
        value: <%= ENV['ELB_SUBNETS'] || "subnet-9dbd6af4,subnet-d502f5ae" %>
      #
      # Enable log publishing to S3
      #
      - namespace: aws:elasticbeanstalk:hostmanager
        option_name: LogPublicationControl
        value: "true"
      #
      # Notifications
      #
      - namespace: aws:elasticbeanstalk:sns:topics
        option_name: NotificationTopicName
        value: <%= ENV['NOTIFICATION_TOPIC'] || "production-notification" %>


